# MQTT Remote Monitoring for Crop Steering
# Enables external monitoring and control via MQTT

template:
  - sensor:
      # MQTT STATUS MONITOR
      - name: "cs_mqtt_status"
        unique_id: cs_mqtt_status
        state: >
          {% if is_state('input_boolean.cs_mqtt_enabled', 'on') %}
            {% if states('sensor.cs_mqtt_last_publish') != 'unknown' %}
              {% set last_publish = as_timestamp(states('sensor.cs_mqtt_last_publish')) | default(0) %}
              {% set current_time = now().timestamp() %}
              {% if (current_time - last_publish) < 300 %}
                online
              {% else %}
                stale
              {% endif %}
            {% else %}
              initializing
            {% endif %}
          {% else %}
            disabled
          {% endif %}
        icon: >
          {% set status = states('sensor.cs_mqtt_status') %}
          {% if status == 'online' %}
            mdi:wifi
          {% elif status == 'stale' %}
            mdi:wifi-off
          {% elif status == 'initializing' %}
            mdi:wifi-cog
          {% else %}
            mdi:wifi-off
          {% endif %}
        attributes:
          last_publish: "{{ states('sensor.cs_mqtt_last_publish') }}"
          publish_interval: "{{ states('input_number.cs_mqtt_publish_interval') }}s"
          enabled: "{{ is_state('input_boolean.cs_mqtt_enabled', 'on') }}"

      # MQTT PAYLOAD GENERATOR
      - name: "cs_mqtt_data_payload"
        unique_id: cs_mqtt_data_payload
        state: >
          {
            "timestamp": {{ now().timestamp() | round(0) }},
            "system": {
              "phase": "{{ states('input_select.cs_crop_steering_phase') }}",
              "mode": "{{ states('input_select.cs_steering_mode') }}",
              "status": "{{ states('sensor.cs_irrigation_status') }}"
            },
            "sensors": {
              "vwc_avg": {{ states('sensor.cs_configured_avg_vwc') | float(0) }},
              "vwc_min": {{ states('sensor.cs_configured_min_vwc') | float(0) }},
              "vwc_max": {{ states('sensor.cs_configured_max_vwc') | float(0) }},
              "ec_avg": {{ states('sensor.cs_configured_avg_ec') | float(0) }},
              "ec_ratio": {{ states('sensor.cs_ec_ratio') | float(0) }}
            },
            "analytics": {
              "efficiency_24h": {{ states('sensor.cs_irrigation_efficiency_24h') | float(0) }},
              "water_used_24h": {{ states('sensor.cs_total_water_used_24h') | float(0) }},
              "shots_24h": {{ states('sensor.cs_total_shots_24h') | float(0) }},
              "dryback_avg_24h": {{ states('sensor.dryback_avg_percentage_24h') | float(0) }}
            },
            "health": {
              "sensor_health": {{ states('sensor.cs_sensor_health_score') | float(0) }},
              "fusion_confidence": {{ state_attr('sensor.cs_fused_vwc_reading', 'confidence_level') | default(0) }},
              "outliers_detected": {{ state_attr('sensor.cs_fused_vwc_reading', 'outliers_detected') | default(0) }}
            },
            "recommendations": {
              "optimization": "{{ states('sensor.cs_optimization_recommendation') }}",
              "growth_stage": "{{ states('sensor.cs_growth_stage_recommendation') }}",
              "optimal_zone": "{{ states('sensor.cs_optimal_irrigation_zone') }}"
            }
          }
        attributes:
          topic: "{{ states('input_text.cs_mqtt_data_topic') }}"
          size_bytes: "{{ states('sensor.cs_mqtt_data_payload') | length }}"

      # MQTT ALERT PAYLOAD GENERATOR
      - name: "cs_mqtt_alert_payload"
        unique_id: cs_mqtt_alert_payload
        state: >
          {% if is_state('binary_sensor.cs_sensor_fusion_alert', 'on') or 
                is_state('binary_sensor.cs_data_quality_warning', 'on') %}
            {
              "timestamp": {{ now().timestamp() | round(0) }},
              "alert_type": "system_warning",
              "severity": "medium",
              "alerts": [
                {% if is_state('binary_sensor.cs_sensor_fusion_alert', 'on') %}
                {
                  "type": "sensor_fusion",
                  "message": "{{ state_attr('binary_sensor.cs_sensor_fusion_alert', 'alert_reason') }}",
                  "vwc_outliers": {{ state_attr('binary_sensor.cs_sensor_fusion_alert', 'vwc_outliers') | default(0) }},
                  "ec_outliers": {{ state_attr('binary_sensor.cs_sensor_fusion_alert', 'ec_outliers') | default(0) }}
                }{% if is_state('binary_sensor.cs_data_quality_warning', 'on') %},{% endif %}
                {% endif %}
                {% if is_state('binary_sensor.cs_data_quality_warning', 'on') %}
                {
                  "type": "data_quality",
                  "message": "{{ state_attr('binary_sensor.cs_data_quality_warning', 'recommendation') }}",
                  "vwc_sensors": {{ state_attr('binary_sensor.cs_data_quality_warning', 'vwc_sensor_count') | default(0) }},
                  "ec_sensors": {{ state_attr('binary_sensor.cs_data_quality_warning', 'ec_sensor_count') | default(0) }}
                }
                {% endif %}
              ]
            }
          {% else %}
            null
          {% endif %}
        attributes:
          topic: "{{ states('input_text.cs_mqtt_alert_topic') }}"
          has_alerts: >
            {{ is_state('binary_sensor.cs_sensor_fusion_alert', 'on') or 
               is_state('binary_sensor.cs_data_quality_warning', 'on') }}

      - name: "cs_mqtt_last_publish"
        unique_id: cs_mqtt_last_publish
        state: "{{ states('input_datetime.cs_mqtt_last_publish_time') }}"
        device_class: timestamp